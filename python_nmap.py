import nmap
from pycvesearch import CVESearch

#Checks if the CVSS is above the threshold score, if it is, print associated information.
def filter_cve(json, cpe):
	if float(json['cvss']) > threshold:
		print('CPE: %s\nCVSS: %s\nDescription: %s\nMore information: %s\n' % (cpe, json['cvss'], json['summary'], 'https://www.cvedetails.com/cve/' + json['id'] + '/'))

nm = nmap.PortScanner()
cvesearcher = CVESearch()

threshold = 7.0
#Sometimes nmap can't determine a version for a service. When that happens, it returns a versionless CPE which will return all CVE's for all versions of that software. This is a list of CPE's to ignore to cut down on false positives.
versionless_cpes = ['cpe:/o:microsoft:windows', 'cpe:/a:oracle:application_server', 'cpe:/o:vmware:esx', 'cpe:/a:apache:http_server']
hostsToScan = []

#open file of line-delimited ip addresses to scan
with open("hosts_to_scan.txt", "r") as f:
	for line in f:
		hostsToScan.append(line.rstrip())

#iterate through hosts	
for ip in hostsToScan:
	print('Scanning %s:' % ip) 
	nm.scan(ip, arguments = '-sV -O --version-all')
	
	for host in nm.all_hosts():
		print('Host: %s (%s)' % (host, nm[host].hostname()))
		print('State: %s' % nm[host].state())
		#print('OS CPE: %s' % nm[host].get('osclass'))
		#print(nm[host])
		for proto in nm[host].all_protocols():
			port_list = nm[host][proto].keys()

			for port in port_list:
				#print('CPE: %s' % nm[host][proto][port]['cpe'])
				if nm[host][proto][port]['cpe'] and nm[host][proto][port]['cpe'] not in versionless_cpes: 
					for cve in cvesearcher.cvefor(nm[host][proto][port]['cpe']):
						filter_cve(cve, nm[host][proto][port]['cpe'])
					else:
						print('Nmap could not determine version number for CPE: %s, please manually check version of this service.' % nm[host][proto][port]['cpe'])
				print ('Port : %s\tProduct: %s %s' % (port, nm[host][proto][port]['product'], nm[host][proto][port]['version']))
	
	print("==========================================================")